@model Cph.Data.Project
@{
    ViewBag.Title = "Edit";
}
<h1 class="page-header">Edit project</h1>
<div id="project-edit" class="row">
    @{Html.RenderPartial("EditForm");}
</div>
    
@section scripts {
    <script src="~/js/jquery.signalR-1.1.3.js"></script>
    <script src="~/signalr/hubs"></script>
    <script>
        $(function() {
            var lock = $.connection.lockHub;
            lock.client.unlock = function(entityId) {
                if (entityId == '@Model.GetEntityId()') {
                    setFormEnabled(true);
                }
            };
            lock.client.lock = function(entityId) {
                if (entityId == '@Model.GetEntityId()') {
                    setFormEnabled(false);
                }
            };
            lock.client.update = function(entityId) {
                if (entityId == '@Model.GetEntityId()') {
                    $.get('@Url.Action("EditForm", new {name = Model.Name})', function (html) {
                        var editBox = $('#project-edit'),
                            wasDisabled = !isFormEnabled();
                        
                        // update html
                        editBox.html(html);
                        if (wasDisabled) setFormEnabled(false);
                        
                        // refresh stuff
                        cph.init(jQuery);
                        cph.refreshValidation($('#project-edit'));
                    });
                }
            };
            $.connection.hub.start().done(function() {
                lock.server.lock('@Model.GetEntityId()').done(function(ok) {
                    if (!ok) setFormEnabled(false);
                });
            });
            function setFormEnabled(enabled) {
                $('#project-edit form').find(':input, textarea').attr('disabled', !enabled);
            }
            function isFormEnabled() {
                $('#project-edit form').find(':input:first').is(':enabled');
            }
        });
    </script>
}